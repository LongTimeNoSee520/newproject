<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zjtc.mapper.UseWaterSelfDefinePlanMapper">
  <!-- TWUseWaterSelfDefinePlan的resultMap,column是给数据库列起的别名,它对应property类的属性 -->

  <resultMap id="TWUseWaterSelfDefinePlanModel" type="com.zjtc.model.UseWaterSelfDefinePlan">
    <result column="id" property="id" jdbcType="VARCHAR"/>
    <result column="node_code" property="nodeCode" jdbcType="VARCHAR"/>
    <result column="use_water_unit_id" property="useWaterUnitId" jdbcType="VARCHAR"/>
    <result column="unit_name" property="unitName" jdbcType="VARCHAR"/>
    <result column="unit_code" property="unitCode" jdbcType="VARCHAR"/>
    <result column="water_meter_code" property="waterMeterCode" jdbcType="VARCHAR"/>
    <result column="plan_year" property="planYear" jdbcType="INTEGER"/>
    <result column="cur_year_plan" property="curYearPlan" jdbcType="INTEGER"/>
    <result column="first_quarter" property="firstQuarter" jdbcType="INTEGER"/>
    <result column="second_quarter" property="secondQuarter" jdbcType="INTEGER"/>
    <result column="third_quarter" property="thirdQuarter" jdbcType="INTEGER"/>
    <result column="fourth_quarter" property="fourthQuarter" jdbcType="INTEGER"/>
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    <result column="audit_time" property="auditTime" jdbcType="VARCHAR"/>
    <result column="audit_person" property="auditPerson" jdbcType="VARCHAR"/>
    <result column="audit_person_id" property="auditPersonId" jdbcType="VARCHAR"/>
    <result column="audit_result" property="auditResult" jdbcType="VARCHAR"/>
    <result column="execute_time" property="executeTime" jdbcType="TIMESTAMP"/>
    <result column="executor" property="executor" jdbcType="VARCHAR"/>
    <result column="executor_id" property="executorId" jdbcType="VARCHAR"/>
    <result column="execute_result" property="executeResult" jdbcType="VARCHAR"/>
    <result column="change_type" property="changeType" jdbcType="VARCHAR"/>
    <result column="audit_status" property="auditStatus" jdbcType="VARCHAR"/>
    <result column="executed" property="executed" jdbcType="VARCHAR"/>
    <result column="self_define_file_id" property="selfDefineFileId" jdbcType="VARCHAR"/>
  </resultMap>


  <resultMap id="UseWaterSelfDefinePlanVOModel" type="com.zjtc.model.vo.UseWaterSelfDefinePlanVO">
    <result column="id" property="id" jdbcType="VARCHAR"/>
    <result column="node_code" property="nodeCode" jdbcType="VARCHAR"/>
    <result column="use_water_unit_id" property="useWaterUnitId" jdbcType="VARCHAR"/>
    <result column="unit_name" property="unitName" jdbcType="VARCHAR"/>
    <result column="unit_code" property="unitCode" jdbcType="VARCHAR"/>
    <result column="water_meter_code" property="waterMeterCode" jdbcType="VARCHAR"/>
    <result column="plan_year" property="planYear" jdbcType="INTEGER"/>
    <result column="cur_year_plan" property="curYearPlan" jdbcType="INTEGER"/>
    <result column="first_quarter" property="firstQuarter" jdbcType="INTEGER"/>
    <result column="second_quarter" property="secondQuarter" jdbcType="INTEGER"/>
    <result column="third_quarter" property="thirdQuarter" jdbcType="INTEGER"/>
    <result column="fourth_quarter" property="fourthQuarter" jdbcType="INTEGER"/>
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    <result column="audit_time" property="auditTime" jdbcType="VARCHAR"/>
    <result column="audit_person" property="auditPerson" jdbcType="VARCHAR"/>
    <result column="audit_person_id" property="auditPersonId" jdbcType="VARCHAR"/>
    <result column="audit_result" property="auditResult" jdbcType="VARCHAR"/>
    <result column="execute_time" property="executeTime" jdbcType="TIMESTAMP"/>
    <result column="executor" property="executor" jdbcType="VARCHAR"/>
    <result column="executor_id" property="executorId" jdbcType="VARCHAR"/>
    <result column="execute_result" property="executeResult" jdbcType="VARCHAR"/>
    <result column="change_type" property="changeType" jdbcType="VARCHAR"/>
    <result column="audit_status" property="auditStatus" jdbcType="VARCHAR"/>
    <result column="executed" property="executed" jdbcType="VARCHAR"/>
    <collection property="selfDefineFileId" column="id" ofType="com.zjtc.model.File"
      select="SelectSysAttrFileMap"/>
  </resultMap>

  <resultMap id="sysAttrFileMap" type="com.zjtc.model.File">
    <id column="id" property="id" jdbcType="VARCHAR"/>
    <result column="node_code" property="nodeCode" jdbcType="VARCHAR"/>
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    <result column="creater_id" property="createrId" jdbcType="VARCHAR"/>
    <result column="file_type" property="fileType" jdbcType="VARCHAR"/>
    <result column="size" property="size" jdbcType="VARCHAR"/>
    <result column="file_path" property="filePath" jdbcType="VARCHAR"/>
    <result column="file_name" property="fileName" jdbcType="VARCHAR"/>
    <result column="business_id" property="businessId" jdbcType="VARCHAR"/>
    <result column="deleted" property="deleted" jdbcType="VARCHAR"/>
  </resultMap>


  <resultMap id="BaseResultMap" type="com.zjtc.model.UseWaterPlan">
    <result column="id" property="id" jdbcType="VARCHAR"/>
    <result column="node_code" property="nodeCode" jdbcType="VARCHAR"/>
    <result column="use_water_unit_id" property="useWaterUnitId" jdbcType="VARCHAR"/>
    <result column="unit_name" property="unitName" jdbcType="VARCHAR"/>
    <result column="unit_code" property="unitCode" jdbcType="VARCHAR"/>
    <result column="algorithm_type" property="algorithmType" jdbcType="VARCHAR"/>
    <result column="water_meter_code" property="waterMeterCode" jdbcType="VARCHAR"/>
    <result column="plan_year" property="planYear" jdbcType="INTEGER"/>
    <result column="base_water_amount" property="baseWaterAmount" jdbcType="DOUBLE"/>
    <result column="before_last_year_water_amount" property="beforeLastYearWaterAmount"
      jdbcType="DOUBLE"/>
    <result column="last_year_water_amount" property="lastYearWaterAmount" jdbcType="DOUBLE"/>
    <result column="three_year_avg" property="threeYearAvg" jdbcType="DOUBLE"/>
    <result column="now_price" property="nowPrice" jdbcType="DOUBLE"/>
    <result column="n8" property="n8" jdbcType="INTEGER"/>
    <result column="minus_pay_status" property="minusPayStatus" jdbcType="VARCHAR"/>
    <result column="balance_test" property="balanceTest" jdbcType="VARCHAR"/>
    <result column="create_type" property="createType" jdbcType="VARCHAR"/>
    <result column="cur_year_base_plan" property="curYearBasePlan" jdbcType="DOUBLE"/>
    <result column="cur_year_plan" property="curYearPlan" jdbcType="DOUBLE"/>
    <result column="next_year_start_plan" property="nextYearStartPlan" jdbcType="DOUBLE"/>
    <result column="next_year_end_plan" property="nextYearEndPlan" jdbcType="DOUBLE"/>
    <result column="first_quarter" property="firstQuarter" jdbcType="DOUBLE"/>
    <result column="second_quarter" property="secondQuarter" jdbcType="DOUBLE"/>
    <result column="third_quarter" property="thirdQuarter" jdbcType="DOUBLE"/>
    <result column="fourth_quarter" property="fourthQuarter" jdbcType="DOUBLE"/>
    <result column="plan_type" property="planType" jdbcType="VARCHAR"/>
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    <result column="update_user_id" property="updateUserId" jdbcType="VARCHAR"/>
    <result column="added" property="added" jdbcType="VARCHAR"/>
    <result column="reduce_plan" property="reducePlan" jdbcType="DOUBLE"/>
    <result column="reward_plan" property="rewardPlan" jdbcType="DOUBLE"/>
    <result column="assess_quarter" property="assessQuarter" jdbcType="VARCHAR"/>
    <result column="remarks" property="remarks" jdbcType="VARCHAR"/>
  </resultMap>

  <select id="queryList" parameterType="java.util.Map" resultMap="UseWaterSelfDefinePlanVOModel">
    SELECT TOP
    ${pageSize} c.*
    FROM
    (
    SELECT
    row_number () OVER ( ORDER BY [unit_code] ) AS rownumber,
    id,
    node_code,
    use_water_unit_id,
    unit_name,
    unit_code,
    water_meter_code,
    plan_year,
    cur_year_plan,
    first_quarter,
    second_quarter,
    third_quarter,
    fourth_quarter,
    create_time,
    audit_time,
    audit_person,
    audit_person_id,
    audit_result,
    execute_time,
    executor,
    executor_id,
    execute_result,
    change_type,
    CASE audit_status
    WHEN 0 THEN '未审核'
    WHEN 1 THEN '审核不通过'
    WHEN 2 THEN '审核通过'
    END as audit_status,
    CASE executed
    WHEN 0 THEN '未执行'
    WHEN 1 THEN '已执行'
    END as executed
    FROM
    t_w_use_water_self_define_plan t1
    WHERE t1.node_code = #{nodeCode}
    <if test="unitName != null and unitName != ''">
      and t1.unit_name like '%${unitName}%'
    </if>
    <if test="userType != null and userType != ''">
      and SUBSTRING(t1.unit_code,3,2) like '%${userType}%'
    </if>
    <if test="areaCode != null and areaCode != ''">
      and SUBSTRING(t1.unit_code,1,2) like '%${areaCode}%'
    </if>
    <if test="beginYear != null  or endYear != null">
      and (t1.plan_year &gt;= #{beginYear} and t1.plan_year &lt;= #{endYear})
    </if>
    <if test="unitCode != null and unitCode != ''">
      and t1.unit_code like '%${unitCode}%'
    </if>
    <if test="auditStatus != null and auditStatus != ''">
      and t1.audit_status = #{auditStatus}
    </if>
    <if test="executed != null and executed != ''">
      and t1.executed = #{executed}
    </if>
     and id IN (
    SELECT
    id
    FROM
    t_w_use_water_self_define_plan
    WHERE
    node_code = #{nodeCode}
    AND SUBSTRING ( unit_code, 3, 2 )
    IN ( SELECT unit_type_code
    FROM t_w_use_water_unit_role WHERE person_id = #{userId}))
    ) c
    WHERE
    rownumber > (${pageSize}*(${currPage}-1))
  </select>

  <select id="selectCount" resultType="int">

    SELECT
    count(1)
    FROM
    t_w_use_water_self_define_plan t1
    WHERE 1 = 1
    AND t1.node_code = #{nodeCode}
    <if test="unitName != null and unitName != ''">
      and t1.unit_name like '%${unitName}%'
    </if>
    <if test="userType != null and userType != ''">
      and SUBSTRING(t1.unit_code,3,2) like '%${userType}%'
    </if>
    <if test="areaCode != null and areaCode != ''">
      and SUBSTRING(t1.unit_code,1,2) like '%${areaCode}%'
    </if>
    <if test="beginYear != null  or endYear != null">
      and (t1.plan_year &gt;= #{beginYear} and t1.plan_year &lt;= #{endYear})
    </if>
    <if test="unitCode != null and unitCode != ''">
      and t1.unit_code like '%${unitCode}%'
    </if>
    <if test="auditStatus != null and auditStatus != ''">
      and t1.audit_status = #{auditStatus}
    </if>
    <if test="executed != null and executed != ''">
      and t1.executed = #{executed}
    </if>
    and id IN (
    SELECT
    id
    FROM
    t_w_use_water_self_define_plan
    WHERE
    node_code = #{nodeCode}
    AND SUBSTRING ( unit_code, 3, 2 )
    IN ( SELECT unit_type_code
    FROM t_w_use_water_unit_role WHERE person_id = #{userId}))
  </select>


<!--  <select id="SelectSysAttrFileMap" resultMap="sysAttrFileMap">-->
<!--    select-->
<!--    id,-->
<!--    node_code,-->
<!--    create_time,-->
<!--    creater_id,-->
<!--    file_type,-->
<!--    size,-->
<!--    file_path,-->
<!--    file_name,-->
<!--    business_id-->
<!--    from-->
<!--    t_file-->
<!--    where business_id = #{id}-->
<!--    and deleted='0'-->
<!--  </select>-->

  <select id="SelectSysAttrFileMap"  resultMap="sysAttrFileMap">
    SELECT
    id,
    node_code,
    create_time,
    creater_id,
    file_type,
    size,
    file_path,
    file_name,
    business_id
    FROM t_file
    WHERE deleted ='0'
    AND id
    IN (
    SELECT  SUBSTRING(a.other_file_id,number,CHARINDEX(',',a.other_file_id+',',number)-number) as other_file_id
    from (SELECT other_file_id
    FROM t_wx_use_water_plan_add
    WHERE id = #{id} ) a,master..spt_values
    where number >= 1 and number  &lt; len(a.other_file_id)
    and type='p'
    and SUBSTRING(','+a.other_file_id,number,1)=','
    ) <!--将逗号隔开的字符串拆分为行-->
  </select>

  <update id="updateExecuteData">
    update t_w_use_water_self_define_plan set
    executed = '1',
    execute_time = #{executeTime},
    executor = #{executor},
    executor_id = #{executorId},
    execute_result = '1'
    where id = #{id}
  </update>

  <select id="selectFileId" resultType="java.lang.String">
    SELECT
    t2.id
    FROM
    t_w_use_water_self_define_plan t1
    LEFT JOIN t_file t2 ON t1.id = t2.business_id
    WHERE
    t2.deleted = '0'
    and t2.business_id = #{id}
  </select>

  <update id="updateUseWaterPlanWater">
    update t_w_use_water_plan set
    first_quarter = #{firstQuarter},
    second_quarter = #{secondQuarter},
    third_quarter = #{thirdQuarter},
    fourth_quarter = #{fourthQuarter},
    cur_year_plan = #{curYearPlan},
    update_user_id = #{executorId},
    update_time = #{updateTime}
    where id = #{id}
  </update>

  <select id="selectWaterPlan" resultMap="BaseResultMap">
    select * from
    t_w_use_water_plan where
    node_code = #{nodeCode} and
    use_water_unit_id = #{useWaterUnitId} and
    unit_name = #{unitName} and
    unit_code = #{unitCode} and
    plan_year= #{planYear}
  </select>

  <select id="selectAuditStatus" resultMap="TWUseWaterSelfDefinePlanModel">
    select * FROM t_w_use_water_self_define_plan WHERE (audit_status = '0' OR audit_status = '1')
    and id = #{id}
  </select>

  <select id="selectExecuted" resultMap="TWUseWaterSelfDefinePlanModel">
    select * FROM t_w_use_water_self_define_plan WHERE executed = '1'  and id = #{id}
  </select>
</mapper>